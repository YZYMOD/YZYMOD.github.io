<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sprite Sheet Animation Test</title>
  <style>
    #spriteCanvas {
      border: 3px solid #6c757d;
      background-color: #f8f9fa;
      display: block;
      margin: 20px auto;
    }
    body { text-align: center; font-family: Arial, sans-serif; }
  </style>
</head>
<body>
  <h1>GF Dancing Animation Test</h1>
  <!-- Canvas resized to comfortably fit 186x269 frames -->
  <canvas id="spriteCanvas" width="500" height="350"></canvas>

  <!-- IMPORTANT: Removed XML declaration because it breaks parsing inside HTML -->
  <script id="xmlData" type="text/xml">
    <TextureAtlas imagePath="Untitled_design_1.png">
      <SubTexture name="GF Dancing0000" x="0" y="0" width="186" height="269"/>
      <SubTexture name="GF Dancing0001" x="186" y="0" width="186" height="269"/>
      <SubTexture name="GF Dancing0002" x="372" y="0" width="186" height="269"/>
      <SubTexture name="GF Dancing0003" x="558" y="0" width="186" height="269"/>
      <SubTexture name="GF Dancing0004" x="744" y="0" width="186" height="269"/>
      <SubTexture name="GF Dancing0005" x="930" y="0" width="186" height="269"/>
      <SubTexture name="GF Dancing0006" x="1116" y="0" width="186" height="269"/>
      <SubTexture name="GF Dancing0007" x="1302" y="0" width="186" height="269"/>
      <SubTexture name="GF Dancing0008" x="1488" y="0" width="186" height="269"/>
      <SubTexture name="GF Dancing0009" x="1674" y="0" width="186" height="269"/>
      <Animation name="GF_IDLE" anim="GF Dancing" indices="0,1,2,3,4,5,6,7,8,9" fps="12" loop="true"/>
    </TextureAtlas>
  </script>

  <script>
    const canvas = document.getElementById('spriteCanvas');
    const ctx = canvas.getContext('2d');

    let spriteData = {};

    const xmlText = document.getElementById('xmlData').textContent.trim();
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

    const atlas = xmlDoc.querySelector('TextureAtlas');
    const IMAGE_FILE = atlas.getAttribute('imagePath');

    const spriteImage = new Image();
    spriteImage.src = IMAGE_FILE;

    function parseXMLData() {
      const subTextures = xmlDoc.querySelectorAll('SubTexture');
      subTextures.forEach(sub => {
        spriteData[sub.getAttribute('name')] = {
          x: +sub.getAttribute('x'),
          y: +sub.getAttribute('y'),
          width: +sub.getAttribute('width'),
          height: +sub.getAttribute('height')
        };
      });

      const anim = xmlDoc.querySelector('Animation[name="GF_IDLE"]');
      spriteData.GF_IDLE_ANIMATION = {
        prefix: anim.getAttribute('anim'),
        indices: anim.getAttribute('indices').split(',').map(n => parseInt(n)),
        fps: parseInt(anim.getAttribute('fps')),
        loop: anim.getAttribute('loop') === 'true'
      };
    }

    let currentFrameIndex = 0;
    let lastTime = 0;

    spriteImage.onload = () => {
      parseXMLData();
      requestAnimationFrame(gameLoop);
    };

    spriteImage.onerror = () => {
      alert('Failed to load sprite image: ' + IMAGE_FILE);
    };

    function gameLoop(time) {
      if (!lastTime) lastTime = time;
      const delta = time - lastTime;

      const anim = spriteData.GF_IDLE_ANIMATION;
      const msPerFrame = 1000 / anim.fps;

      if (delta >= msPerFrame) {
        currentFrameIndex = (currentFrameIndex + 1) % anim.indices.length;
        lastTime = time;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const frameNum = anim.indices[currentFrameIndex];
      const frameName = anim.prefix + String(frameNum).padStart(4, '0');
      const frame = spriteData[frameName];

      if (frame) {
        const scale = 1; // change to 2 to make sprite bigger

        const drawW = frame.width * scale;
        const drawH = frame.height * scale;

        const x = (canvas.width - drawW) / 2;
        const y = (canvas.height - drawH) / 2;

        ctx.drawImage(
          spriteImage,
          frame.x,
          frame.y,
          frame.width,
          frame.height,
          x,
          y,
          drawW,
          drawH
        );
      }

      requestAnimationFrame(gameLoop);
    }
  </script>
</body>
</html>
